<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<script>
		function doLogout() {
			const Http = new XMLHttpRequest();
			const url = 'http://127.0.0.1:8001/login';

			Http.open("DELETE", url);
			Http.send();

			Http.onload = function () {
				switch (Http.status) {
					case 200:
						document.cookie = "";
						window.location.href = '/login'
						break;

					default:
						alert("Logout failed due to: " + Http.statusText);
						break;
				}
			};
		}
	</script>
	<link rel="stylesheet" href="../chat/chat.css">
</head>

<body>
	<div class="bg"></div>
	<div id="wrapper">
		<table>
			<tr id="header">
				<td id="title" class="column">Some dialog</td>
				<td id="info" class="column">
					<button onclick="doLogout()">Info</button>
				</td>
			</tr>
			<tr>
				<td id="dialog" class="column">
					<div class="message myMessage">
						<p>bot 1</p>
					</div>
					<div class="message chatMessage">
						<p>bot 2</p>
					</div>
				</td>
			</tr>
		</table>
	</div>

	<script>
		let socket = new WebSocket("ws://127.0.0.1:8001/websocket");
		let map = new Map();
		let mytoken = "";
		let myname = "";

		socket.onopen = function(e) {
			console.log("Connection established");
		};

		socket.onmessage = function(event) {
			let state = event.data[0];
			let message = event.data.substr(1);
			let uuidLength = 36;
			let token = message.substr(0, uuidLength - 1);

			if (token === mytoken)
			{
				return;
			}

			switch (state)
			{
				case 'a':
				{
					let username = message.substr(uuidLength);
					map.set(token, username + "+");
					break;
				}
				case 'i':
				{
					mytoken = token;
					myname = message.substr(uuidLength);
				}
				case 'l':
				{
					for (let i = 0; i < message.length; i += uuidLength)
					{
						token = message.substr(i, i + uuidLength - 1);
						map.delete(token);
					}
					break;
				}
				case 'c':
				{
					for (let i = 0; i < message.length; i += uuidLength)
					{
						token = message.substr(i, i + uuidLength - 1);
						let username = map.get(token);
						username = username.replace(/.$/,"-");
						map.set(token, username);
					}					
					break;
				}
				case 'o':
				{
					for (let i = 0; i < message.length; i += uuidLength)
					{
						token = message.substr(i, i + uuidLength - 1);
						let username = map.get(token);
						username = username.replace(/.$/,"+");
						map.set(token, username);
					}
					break;
				}
			}

			console.log("-------------------");
			console.log(map);
			console.log("-------------------");
		};	
	</script>
</body>

</html>